<script type="text/javascript">
/**
  Example:
  RpcSql('<%= api_path %>')
    .select('posts.id', 'email', 'title', 'body')
    .from('users')
    .join('posts', 'users.id', '=', 'posts.user_id')
    .orderBy('posts.id desc')
    .post(callbackFn)
**/

  function RpcSql(url) {
    var fn = {}
    var payload = {
      select: [],
      from: "",
      joins: [],
      where: [],
      groupBy: [],
      orderBy: []
    }

    fn.select = function(cols) {
      payload.select = payload.select.concat(Array.from(arguments))
      return fn
    }

    fn.from = function(table) {
      payload.from = table
      return fn
    }

    fn.join = function(table, col1, operator, col2) {
      var str = "join " + table + " on " + col1 + " " + operator + " " + col2
      payload.joins.push(str)
      return fn
    }

    fn.where = function(eq) {
      payload.where.push(eq)
      return fn
    }

    fn.groupBy = function(col) {
      payload.groupBy.push(col)
      return fn
    }

    fn.orderBy = function(col, direction) {
      payload.orderBy.push(col + " " + direction)
      return fn
    }

    fn.overwrite = function(newPayload) {
      payload = newPayload
      return fn
    }

    fn.post = function(successFn) {
      var postData = JSON.stringify(payload)
      $.post(url, postData, function(data) {
        successFn(data)
      }, 'json')
    }

    return fn;
  }
</script>
